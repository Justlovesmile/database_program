<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="shortcut icon" href="/static/img/logo.png">
    <script type="text/javascript" src="/static/js/jquery-3.4.1.js"></script>
    <link rel="stylesheet" href="/static/css/base.css">
    <script type="text/javascript" src="/static/js/check_session.js"></script>
    <title>个人空间</title>

</head>

<body>

    <div class='header'>
        <div class="menu">
            <div>
                <ul class="menubar" id="left_nav">
                    <li class="menu-value"><a class="navbar_img" style="font-weight:bold" href="/">
                            <img src="/static/img/bbs.png" class="navbar_img"></a>
                    <li>
                    <li class=""><a href="/"><span class="glyphicon glyphicon-home"></span> 首页</a></li>
                    <li class=""><a href="/newpost/"><span class="glyphicon glyphicon-time"></span> 最新</a></li>
                    <li class=""><a href="/search/"><span class="glyphicon glyphicon-search"></span> 搜索</a></li>
                    <li class=""><a href="/introduce/"><span class="glyphicon glyphicon-info-sign"></span> 说明</a></li>
                </ul>
                <ul class="menubar_right" id="right_nav">
                    <li id="session_check_nav"><a href='/login/'> 登陆</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="content" style="display: block;">
        <main class='content_box' style="overflow:hidden;">
            <div class='card' style='float:right !important;width:25%;margin-bottom: 10px;'>
                <img src="/static/img/user_img.jpeg" alt="用户头像" class="img-thumbnail">
            </div>
            <div class='card' style='float:right !important;width:75%;margin-bottom: 10px;'>
                <div class='card' id='user_nickname'>
                    <! -- 用户昵称 -->
                </div>
                <div class='card' id='user_info'>
                    <! -- 用户信息 -->
                </div>
                <p id='search_ans_title'></p>
                <div class='card' id='search_ans'>
                    <! -- 用户记录 -->
                </div>
            </div>
        </main>
    </div>
    <script>
        //删除帖子函数
        delete_post=function(post_id){
            data={
                'id':post_id,
                'table':'posts'
            }
            $.post('/delete/',data,function(ans){
                if(ans=='ok'){
                    alert('删除成功！')
                    location.reload()
                }
                else{
                    alert('很奇怪！删除失败了！')
                }
            })

        }
        //删除评论函数
        delete_comment=function(comment_id){
            data={
                'id':comment_id,
                'table':'comments'
            }
            $.post('/delete/',data,function(ans){
                if(ans=='ok'){
                    alert('删除成功！')
                    location.reload()
                }
                else{
                    alert('很奇怪！删除失败了！')
                }
            })
        }
        //设置session['post_id']
        set_session = function (post_id) {
            data = {
                'post_id': post_id
            }
            $.post('/set-session-postid/', data, function (ans) {
                if (ans == "ok") {
                    console.log("添加session成功")
                    window.location.replace("{{ url_for('comment',name='" + post_id + "')}}");
                }
                else {
                    console.log("添加session失败！")
                    return false
                }
            })
        }
        //
        get_user_info = function () {
            $.post('/check-session/', {}, function (nickname) {
                if (nickname == "") {
                    return false
                    alert('用户未登录！')
                }
                else {
                    $.post('/check-permission/', {}, function (ans) {
                        if (ans == 'users') {
                            //是普通用户
                            $.post('/get-user-info/', { 'nickname': nickname }, function (ans) {
                                all_lines = $.parseJSON(ans)
                                eachline = all_lines[0]
                                nickname = eachline[1]
                                name = eachline[2]
                                sex = eachline[3]
                                email = eachline[4]
                                permission_level = eachline[5]
                                $('#user_nickname').append("<p style='text-align:center;'>欢迎：<strong>" + nickname + "</strong></p>")
                                $('#user_info').append("<table class='table table-havor'><thead><tr><th>姓名</th><th>性别</th><th>邮箱</th></tr></thead>"
                                    + "<tbody><tr><td>" + name + "</td><td>" + sex + "</td><td>" + email + "</td></tr></tbody>"
                                    + "</table>")

                                $.post('/get-user-post-comment/', { 'key': 'nickname', 'value': nickname }, function (ans) {
                                    $('#search_ans').empty();
                                    //console.log(ans)
                                    if (ans == "empty") {
                                        alert("您的记录为空！")
                                        return false
                                    }
                                    else {
                                        //alert("找到搜索结果！")
                                        all_lines = $.parseJSON(ans)
                                        var index;
                                        for (index in all_lines) {
                                            each_line = all_lines[index]
                                            //console.log(each_line)
                                            author_id = each_line[0]
                                            nickname = each_line[1]
                                            post_id = each_line[2]
                                            title = each_line[3]
                                            content = each_line[4]
                                            time = each_line[5]
                                            if (typeof title == "number") {
                                                $('#search_ans').append("<div class='card'><a href='javascript:void(0);' onclick='set_session(" + post_id + ")'>"
                                                    + "<div style='padding:10px;background-color: #6fc2d0;'>"
                                                    + "<p style='font-size:15px;overflow: hidden;text-overflow: ellipsis;display: -webkit-box;-webkit-line-clamp: 3;-webkit-box-orient: vertical;'>" + content + "</p>"
                                                    + "<p style='text-align:right;'><small>" + nickname + "</small></p>"
                                                    + "<p style='text-align:right;'><small>" + time + "</small></p></div></a>"
                                                    + "<div align='right' style='position:relative;bottom:10px;top:5px;'>"
                                                    + "<button id='deleteBtn' class='btn btn-default' onclick='delete_comment("+title+")'>删除</button></div>"
                                                    + "</div>");
                                            }
                                            else {
                                                $('#search_ans').append("<div class='card'><a href='javascript:void(0);' onclick='set_session(" + post_id + ")'>"
                                                    + "<div style='padding:10px;background-color: #a6acec;'>"
                                                    + "<p style='font-size:20px;'><strong>" + title + "</strong></p>"
                                                    + "<p style='font-size:15px;overflow: hidden;text-overflow: ellipsis;display: -webkit-box;-webkit-line-clamp: 3;-webkit-box-orient: vertical;'>" + content + "</p>"
                                                    + "<p style='text-align:right;'><small>" + nickname + "</small></p>"
                                                    + "<p style='text-align:right;'><small>" + time + "</small></p></div></a>"
                                                    + "<div align='right' style='position:relative;bottom:10px;top:5px;'>"
                                                    + "<button id='deleteBtn' class='btn btn-default' onclick='delete_post("+post_id+")'>删除</button></div>"
                                                    + "</div>");
                                            }
                                        }
                                        //index是字符串
                                        index = $.parseJSON(index) + 1
                                        $('#search_ans_title').html('<strong>所有记录: 共计' + index + '条</strong>')
                                    }
                                })
                            })
                        }
                        else {
                            //如果是管理员
                            $.post('/get-user-info/', { 'nickname': nickname }, function (ans) {
                                all_lines = $.parseJSON(ans)
                                eachline = all_lines[0]
                                nickname = eachline[1]
                                name = eachline[2]
                                permission_level = eachline[3]
                                $('#user_nickname').append("<p style='text-align:center;'>欢迎：<strong>" + nickname + "</strong></p>")
                                $('#user_info').append("<table class='table table-havor'><thead><tr><th>姓名</th><th>性别</th><th>身份</th></tr></thead>"
                                    + "<tbody><tr><td>" + name + "</td><td>未知</td><td>管理员</td></tr></tbody>"
                                    + "</table>")

                                $.post('/get-post/', {}, function (ans) {
                                    $('#search_ans').empty();
                                    //console.log(ans)
                                    if (ans == "empty") {
                                        alert("很奇怪!记录为空！")
                                        return false
                                    }
                                    else {
                                        //alert("找到搜索结果！")
                                        all_lines = $.parseJSON(ans)
                                        var index;
                                        for (index in all_lines) {
                                            each_line = all_lines[index]
                                            //console.log(each_line)
                                            author_id = each_line[0]
                                            nickname = each_line[1]
                                            post_id = each_line[2]
                                            title = each_line[3]
                                            content = each_line[4]
                                            time = each_line[5]
                                            if (typeof title == "number") {
                                                $('#search_ans').append("<div class='card'><a href='javascript:void(0);' onclick='set_session(" + post_id + ")'>"
                                                    + "<div style='padding:10px;background-color: #6fc2d0;'>"
                                                    + "<p style='font-size:15px;overflow: hidden;text-overflow: ellipsis;display: -webkit-box;-webkit-line-clamp: 3;-webkit-box-orient: vertical;'>" + content + "</p>"
                                                    + "<p style='text-align:right;'><small>" + nickname + "</small></p>"
                                                    + "<p style='text-align:right;'><small>" + time + "</small></p></div></a>"
                                                    + "</div>");
                                            }
                                            else {
                                                $('#search_ans').append("<div class='card'><a href='javascript:void(0);' onclick='set_session(" + post_id + ")'>"
                                                    + "<div style='padding:10px;background-color: #a6acec;'>"
                                                    + "<p style='font-size:20px;'><strong>" + title + "</strong></p>"
                                                    + "<p style='font-size:15px;overflow: hidden;text-overflow: ellipsis;display: -webkit-box;-webkit-line-clamp: 3;-webkit-box-orient: vertical;'>" + content + "</p>"
                                                    + "<p style='text-align:right;'><small>" + nickname + "</small></p>"
                                                    + "<p style='text-align:right;'><small>" + time + "</small></p></div></a>"
                                                    + "</div>");
                                            }
                                        }
                                        //index是字符串
                                        index = $.parseJSON(index) + 1
                                        $('#search_ans_title').html('<strong>用户记录: 共计' + index + '条</strong>')
                                    }
                                })
                            })

                        }
                    })
                }
            })
        }
        $(document).ready(function () {
            get_user_info()
        });
    </script>
    <div class="jumbotron text-center" style='text-align: center;margin-top: 100px;' id="footer">
        <p>哈尔滨工程大学---数据库课程设计---2019</p>
    </div>
</body>

</html>